import{l as K,r as a,m as _,j as e,n as F}from"./index-BlfM3l9C.js";import{C as w}from"./index.esm-BSCVESJC.js";import{C as ee}from"./CContainer-CZv4i3cM.js";import{a as H,C as D}from"./CRow-Drk2HJWZ.js";import{C as te}from"./CCardGroup-D2scS9NE.js";import{C as se}from"./CCard-CUxn-fsT.js";import{C as re}from"./CCardBody-DPpAoAGj.js";import{C as ae}from"./CForm-CCxfabQE.js";import{C as m}from"./CAlert-YoK6qkKi.js";import{C as S}from"./CInputGroup-C7D8o7Hi.js";import{C as L}from"./CInputGroupText-ynlpc-Xt.js";import{c as oe}from"./cil-user-Ddrdy7PS.js";import{C as k}from"./CFormInput-B56y6u5w.js";import{c as ce}from"./cil-lock-locked-DmxpJbVL.js";import{a as U}from"./CButton-DWcO4Axg.js";var ne=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M16,112V496H496V112ZM236.8,341.6a32.167,32.167,0,0,0,38.4,0L298.667,324,464,448v16H48V448L213.333,324ZM256,316,48,160V144H464v16ZM48,200,186.667,304,48,408ZM464,408,325.333,304,464,200Z' class='ci-primary'/>"];const be=()=>{const{showSuccess:p,showError:i}=K(),N={username:"",password:"",isActive:!0},[f,T]=a.useState(N),[o,C]=a.useState(!1),[d,g]=a.useState(0),[c,v]=a.useState(5),[Q,j]=a.useState(0),[I,$]=a.useState(null),[u,A]=a.useState(!1),[E,V]=a.useState(""),[h,q]=a.useState(!1),[R,Z]=a.useState(""),[n,M]=a.useState(!1),[W,y]=a.useState(!1),[x,b]=a.useState(0),G=_(),O=()=>{C(!1),g(0),v(5),j(0),M(!1),V("")},P=s=>{const{id:t,value:r}=s.target;T(l=>({...l,[t]:r}))};a.useEffect(()=>{let s;return o&&d>0&&(s=setInterval(()=>{g(t=>t<=1?(C(!1),0):t-1)},1e3)),()=>{s&&clearInterval(s)}},[o,d]),a.useEffect(()=>{let s;return x>0&&(s=setInterval(()=>{b(t=>t<=1?(y(!0),0):t-1)},1e3)),()=>{s&&clearInterval(s)}},[x]),a.useEffect(()=>((()=>{const t=document.createElement("script");t.src="https://www.google.com/recaptcha/api.js?render=6LeWQQQrAAAAAFt2e1zO5uXtCfmMxF1ohU5VgUYf",t.async=!0,t.defer=!0,t.onload=()=>{console.log("reCAPTCHA v3 script loaded"),p("reCAPTCHA v3 script loaded")},t.onerror=()=>{console.error("Error loading reCAPTCHA v3 script"),i("Error loading reCAPTCHA v3 script")},document.head.appendChild(t)})(),()=>{const t=document.querySelector('script[src*="recaptcha"]');t&&t.remove()}),[]);const Y=async()=>{try{return await window.grecaptcha.execute("6LeWQQQrAAAAAFt2e1zO5uXtCfmMxF1ohU5VgUYf",{action:"login"})}catch(s){throw console.error("reCAPTCHA execution error:",s),i("reCAPTCHA execution error"),s}},z=async()=>{try{y(!1),b(60),(await F.post("api/v1/user/resend-verification",{username:f.username})).data.success&&p("New verification code sent to your email")}catch{i("Failed to resend verification code")}},B=async s=>{s.preventDefault(),A(!0),V("");try{const t=await Y(),r=await F.post("api/v1/user/login",{...f,verificationCode:h?R:void 0,recaptchaToken:t});if(r.data.requiresVerification){q(!0),y(!1),b(60),p("Verification code sent to your email"),A(!1);return}if(r.data.success){const{accessToken:l,refreshToken:X,user:J}=r.data;O(),localStorage.setItem("accessToken",l),localStorage.setItem("refreshToken",X),localStorage.setItem("user",JSON.stringify(J)),p(r.data.message),T(N),setTimeout(()=>{G("/dashboard"),$(null)},2e3)}}catch(t){if(t.response){const{data:r,status:l}=t.response;l===403&&r.isDeactivated?(M(!0),i("Account has been deactivated due to too many failed attempts. Please contact support.")):l===423&&r.isLocked?(C(!0),g(r.timeLeft||Math.ceil((new Date(r.lockUntil)-new Date)/1e3)),v(r.attemptsLeft),j(r.loginAttempts||5),i(`Account temporarily locked. ${r.attemptsLeft} attempts remaining before deactivation.`)):l===401?(v(r.attemptsLeft),j(r.loginAttempts||0),i(r.message)):i(r.message||"An error occurred")}}finally{A(!1)}};return e.jsx("div",{className:"bg-body-tertiary min-vh-100 d-flex flex-row align-items-center",children:e.jsx(ee,{children:e.jsx(H,{className:"justify-content-center",children:e.jsx(D,{xs:12,sm:10,md:8,lg:6,xl:4,children:e.jsx(te,{children:e.jsx(se,{className:"p-4",children:e.jsx(re,{children:e.jsxs(ae,{onSubmit:B,children:[e.jsx("h1",{className:"text-center mb-3",children:"Login"}),e.jsx("p",{className:"text-body-secondary text-center mb-4",children:h?"Enter verification code":"Sign In to your account"}),I&&e.jsx(m,{color:"success",className:"text-success mb-3",children:I}),E&&e.jsx(m,{color:"danger",className:"text-danger mb-3",children:E}),!o&&!n&&c<5&&c>0&&e.jsxs(m,{color:"warning",className:"mb-3",children:["Warning: ",c," ",c===1?"attempt":"attempts"," ","remaining before temporary lock"]}),!n&&c<=5&&Q>=5&&e.jsxs(m,{color:"danger",className:"mb-3",children:["Warning: Account will be deactivated after ",c," more failed"," ",c===1?"attempt":"attempts"]}),o&&e.jsxs(m,{color:"warning",className:"mb-3",children:["Account temporarily locked. Please wait ",Math.floor(d/60),":",(d%60).toString().padStart(2,"0")," minutes.",c>0&&` ${c} attempts remaining before deactivation.`]}),n&&e.jsx(m,{color:"danger",className:"mb-3",children:"Your account has been deactivated due to too many failed attempts. Please contact support to reactivate your account."}),h?e.jsxs(e.Fragment,{children:[e.jsxs(S,{className:"mb-4",children:[e.jsx(L,{children:e.jsx(w,{icon:ne})}),e.jsx(k,{type:"text",placeholder:"Enter verification code",autoComplete:"off",value:R,onChange:s=>Z(s.target.value),required:!0,disabled:o||u||n})]}),e.jsx(U,{color:"link",className:"px-0 mb-4",onClick:z,disabled:!W,children:x>0?`Resend code in ${x}s`:"Resend verification code"})]}):e.jsxs(e.Fragment,{children:[e.jsxs(S,{className:"mb-3",children:[e.jsx(L,{children:e.jsx(w,{icon:oe})}),e.jsx(k,{type:"text",placeholder:"Username",autoComplete:"off",id:"username",required:!0,value:f.username,onChange:P,disabled:o||u||n})]}),e.jsxs(S,{className:"mb-4",children:[e.jsx(L,{children:e.jsx(w,{icon:ce})}),e.jsx(k,{type:"password",placeholder:"Password",autoComplete:"off",id:"password",required:!0,value:f.password,onChange:P,disabled:o||u||n})]})]}),e.jsx("div",{ref:window.recaptchaContainer}),e.jsx(H,{children:e.jsx(D,{xs:6,children:e.jsx(U,{type:"submit",color:"primary",className:"px-4",disabled:o||u||n,children:n?"Account Deactivated":o?`Locked (${Math.floor(d/60)}:${(d%60).toString().padStart(2,"0")})`:u?"Logging in...":h?"Verify":"Login"})})})]})})})})})})})})};export{be as default};
