import{r as l,m as $,j as e,k as E,n as k}from"./index-BTSAY1jP.js";import{a as q,C as z}from"./1-0rsEpf3b.js";import{C as I}from"./CContainer-DEEd9IWu.js";import{a as D,C as y}from"./CRow-DWDEltE9.js";import{C as W}from"./CCard-nIY_lqVA.js";import{C as _}from"./CCardHeader-CsLx56Pv.js";import{C as G}from"./CCardBody-on8ISP2K.js";import{C as U}from"./CAlert-D-e74jgy.js";import{C as J}from"./CForm-DQbMisVi.js";import{a as d,C as c}from"./CFormInput-PBNeC-mo.js";import{a as C}from"./CButton-DR-vKXAR.js";const oe=()=>{const[a,b]=l.useState(null),[j,f]=l.useState(!0),[N,m]=l.useState(null),[F,g]=l.useState(null),[w,P]=l.useState(!1),[A,v]=l.useState(null),x=$(),[s,u]=l.useState({username:"",email:"",currentPassword:"",newPassword:"",confirmPassword:"",photo:null}),S="https://backend-log1.axleshift.com/",R=sessionStorage.getItem("accessToken"),T=async()=>{var i,o,t;try{f(!0),m(null);const n=sessionStorage.getItem("accessToken"),r=await k.get("api/v1/user/profile");r.data.success&&(b(r.data.data),u(p=>({...p,username:r.data.data.username,email:r.data.data.email,photo:null})))}catch(n){if(console.error("Profile fetch error:",n),((i=n.response)==null?void 0:i.status)===401){sessionStorage.removeItem("accessToken"),x("/login");return}m(((t=(o=n.response)==null?void 0:o.data)==null?void 0:t.message)||"Error fetching user data")}finally{f(!1)}};l.useEffect(()=>{if(!R){x("/login");return}T()},[]);const h=i=>{const{id:o,value:t}=i.target;u(n=>({...n,[o]:t}))};l.useEffect(()=>{if(a)if(u({username:a.username||"",email:a.email||"",password:"",confirmPassword:"",role:a.role||"",photo:null}),a.photo){const i=a.photo.startsWith("http")?a.photo:`${S}uploads/profiles/${a.photo}`;v(i)}else v(q)},[a,S]);const L=i=>{const o=i.target.files[0];if(o){u(n=>({...n,photo:o}));const t=new FileReader;t.onloadend=()=>{v(t.result)},t.readAsDataURL(o)}},B=()=>{x("/dashboard")},H=async i=>{var o,t,n;i.preventDefault(),f(!0),m(null),g(null);try{if(s.newPassword||s.confirmPassword){if(!s.currentPassword)throw new Error("Current password is required to set new password");if(s.newPassword!==s.confirmPassword)throw new Error("New passwords do not match")}const r=new FormData;r.append("username",s.username),r.append("email",s.email),s.currentPassword&&r.append("currentPassword",s.currentPassword),s.newPassword&&r.append("newPassword",s.newPassword),s.photo&&r.append("photo",s.photo);const p=await k.put("/api/v1/user/update-profile",r,{headers:{"Content-Type":"multipart/form-data"}});if(p.data.success)g("Profile updated successfully"),b(p.data.data),P(!1),u(M=>({...M,currentPassword:"",newPassword:"",confirmPassword:""}));else throw new Error(p.data.message||"Failed to update profile")}catch(r){console.error("Profile update error:",r),m(((t=(o=r.response)==null?void 0:o.data)==null?void 0:t.message)||r.message),((n=r.response)==null?void 0:n.status)===401&&(sessionStorage.removeItem("accessToken"),x("/login"))}finally{f(!1)}};return j&&!a?e.jsx(I,{className:"d-flex justify-content-center align-items-center",style:{minHeight:"200px"},children:e.jsx(E,{})}):e.jsx(I,{className:"mt-4",children:e.jsx(D,{children:e.jsx(y,{md:8,className:"mx-auto",children:e.jsxs(W,{children:[e.jsx(_,{children:e.jsx("h4",{className:"mb-0",children:"My Account"})}),e.jsxs(G,{children:[N&&e.jsx(U,{color:"danger",dismissible:!0,onClose:()=>m(null),children:N}),F&&e.jsx(U,{color:"success",dismissible:!0,onClose:()=>g(null),children:F}),a&&e.jsxs(J,{onSubmit:H,children:[e.jsxs(D,{className:"mb-3",children:[e.jsx(y,{md:4,className:"text-center",children:e.jsx(z,{rounded:!0,src:A,width:150,height:150,className:"mb-3"})}),e.jsxs(y,{md:8,children:[e.jsxs("div",{className:"mb-3",children:[e.jsx(d,{htmlFor:"username",children:"Username"}),e.jsx(c,{type:"text",id:"username",autoComplete:"off",value:s.username,onChange:h,disabled:!w})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx(d,{htmlFor:"email",children:"Email"}),e.jsx(c,{type:"email",id:"email",autoComplete:"off",value:s.email,onChange:h,disabled:!w})]}),w&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx(d,{htmlFor:"currentPassword",children:"Current Password"}),e.jsx(c,{type:"password",id:"currentPassword",value:s.currentPassword,onChange:h})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx(d,{htmlFor:"newPassword",children:"New Password"}),e.jsx(c,{type:"password",id:"newPassword",value:s.newPassword,onChange:h})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx(d,{htmlFor:"confirmPassword",children:"Confirm Password"}),e.jsx(c,{type:"password",id:"confirmPassword",value:s.confirmPassword,onChange:h})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx(d,{htmlFor:"photo",children:"Profile Photo"}),e.jsx(c,{type:"file",id:"photo",onChange:L,accept:"image/*"})]})]})]})]}),e.jsx("div",{className:"d-flex justify-content-end",children:w?e.jsxs(e.Fragment,{children:[e.jsx(C,{color:"secondary",variant:"outline",onClick:()=>{P(!1)},className:"me-2",children:"Cancel"}),e.jsx(C,{color:"primary",variant:"outline",type:"submit",disabled:j,children:j?e.jsx(E,{size:"sm"}):"Save Changes"})]}):e.jsxs(e.Fragment,{children:[e.jsx(C,{color:"primary",variant:"outline",onClick:()=>P(!0),children:"Edit Profile"}),e.jsx(C,{className:"ms-2",color:"secondary",variant:"outline",onClick:B,children:"Dashboard"})]})})]})]})]})})})})};export{oe as default};
